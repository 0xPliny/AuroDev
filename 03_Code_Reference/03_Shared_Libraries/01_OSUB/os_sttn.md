# os_sttn - MHC_STTN Table Operations

**Document Version:** 1.0  
**Last Updated:** 2024-12-23  
**Author:** CmL  
**Confidence Score:** 0.95

---

## Document Metadata

| Field | Value |
|-------|-------|
| **Source File** | `os_sttn.cpp`, `os_sttn.h` |
| **Generated From** | `MHC_STTN` table definition in `database_tables.xml` |
| **Location** | `D:\ICIS\AuroDev\clogan\AuroDev\MSVC Programs\osub\` |
| **Table Name** | `MHC_STTN` |
| **Primary Key** | `station`, `area` (composite) |
| **Generated By** | `p_ut_makdb` utility |
| **Status** | âœ… Generated - DO NOT MODIFY |

---

## Overview

The `MHC_STTN` table stores **station (stand) database state** for each station in the system. Stations include pickup/dropoff points, infeed/outfeed stations, divert/merge points, and other material handling positions.

**Critical Operations:**
- Station status tracking
- Load presence tracking
- Enroute move counting
- Station availability checking

**Relationship to Shared Memory:**
- Database state is synchronized with shared memory (`cc_stand` class)
- Database provides persistence; shared memory provides real-time access

---

## Table Structure

```cpp
typedef struct sttn
{
    // Audit Fields
    char    modify_user[132+1];          // User who last modified record
    char    history_func[50+1];          // Function that created history entry
    char    history_comment[256+1];      // History comment text
    char    add_date[24+1];              // Date record was added
    char    add_user[132+1];             // User who added record
    char    modify_date[24+1];           // Date record was last modified
    
    // Primary Key Fields
    char    station[30+1];               // Station name (e.g., "PD01")
    char    area[1+1];                   // System area
    
    // Identification Fields
    char    long_name[60+1];             // Long display name
    long    station_index;                // Station index
    long    station_group;               // Station group number
    char    description[132+1];          // Description
    
    // Type and Configuration Fields
    long    type;                        // Station type (see GP.ST.TYP)
    char    station_type[15+1];          // Station type string
    long    address;                     // PLC address
    char    block_number[13+1];         // Block number
    char    plc_name[32+1];             // Associated PLC name
    
    // Status Fields
    long    hard;                        // Hardware status
    long    soft;                        // Software status
    long    enabled;                     // Enabled flag
    long    available;                   // Available flag
    long    auto_mode;                   // Auto mode flag
    bool    osk;                         // OSK (operator station key) flag
    
    // Load Fields
    long    loaded;                      // Load present flag
    char    loadid[15+1];                // Current load ID
    long    actual;                      // Actual count
    long    actual_loaded;               // Actual loaded count
    long    location1;                   // Location 1
    long    location2;                   // Location 2
    
    // Enroute Fields
    long    enroute;                     // Current enroute count
    long    enroute_total;               // Total enroute
    long    max_enroute;                 // Maximum enroute allowed
    long    qued;                        // Queued count
    
    // Mode Fields
    long    mode_current;                // Current mode
    long    lastresult;                  // Last result
    
    // Error Fields
    long    i_error;                     // Internal error
    long    errorflag;                   // Error flag
    char    errorflag_xlat[132+1];       // Error flag translation
    long    errorno;                     // Error number
    char    errorno_xlat[132+1];         // Error number translation
    bool    delete_flag;                 // Delete flag
    
    // BCR Fields
    long    bcr_consnoreadcnt;           // BCR consecutive no-read count
    char    bcr_name1[30+1];             // BCR name 1
    char    bcr_name2[30+1];             // BCR name 2
    char    bcr_name3[30+1];             // BCR name 3
    
    // Associated Equipment Fields
    char    scale_name[30+1];             // Scale name
    char    bcp_name[30+1];              // BCP (barcode printer) name
    char    printer_name[50+1];          // Printer name
    
    // Position Fields
    long    aisle;                       // Aisle number
    long    level_number;                // Level number
    long    level_no;                    // Level number (alternate)
    long    associated_point;            // Associated point
    long    associated_point2;           // Associated point 2
    
    // Cross-Reference Fields
    char    xref[30+1];                  // Cross-reference
    char    xref_next[30+1];            // Cross-reference next
    char    xref_custom[30+1];           // Cross-reference custom
    
    // Order Fields
    char    current_order_header[30+1];   // Current order header
    long    plccaseid;                   // PLC case ID
    
    // History Fields
    long    history_onoff;                // History on/off flag
    
    // Internal Fields
    char    STTN_dum[1];                  // Dummy field (alignment)
    _RecordsetPtr    RsP;                // ADO Recordset pointer (internal use)
} STTN;
```

---

## Primary Key

| Field(s) | Type | Description |
|----------|------|-------------|
| `station` | `char[31]` | Station name (e.g., "PD01") |
| `area` | `char[2]` | System area |

---

## Generated Functions

### STTN_select_STTN_PR_KEY

**Signature:**
```cpp
long STTN_select_STTN_PR_KEY(STTN *sel, GP_BOOL Update);
```

**Description:**
Selects a single STTN record by primary key (`station` and `area`).

**SQL Generated:**
```sql
SELECT * FROM MHC_STTN WHERE station = '{station}' AND area = '{area}'
```

**Usage Example:**
```cpp
STTN sttn;
STTN_init(&sttn);
cc_str.copy(sttn.station, sizeof(sttn.station), "PD01");
cc_str.copy(sttn.area, sizeof(sttn.area), "A");

if (STTN_select_STTN_PR_KEY(&sttn, GP_FALSE) == GP.GOOD) {
    cs_log_printf(FILELINE, 3, "Station %s: loaded=%ld, enroute=%ld/%ld", 
                  sttn.station, sttn.loaded, sttn.enroute, sttn.max_enroute);
}
```

---

### STTN_select_LOOP

**Signature:**
```cpp
long STTN_select_LOOP(STTN *sel, long *count, char *where, GP_BOOL Update, int top = 0);
```

**Description:**
Selects multiple STTN records using a WHERE clause.

**Usage Example:**
```cpp
STTN sttn;
STTN_init(&sttn);
long count = 0;
char where[256];
sprintf(where, "type = %ld AND area = 'A' AND enabled = 1", GP.ST.TYP.PDIN);

// Get all enabled PDIN stations
while (STTN_select_LOOP(&sttn, &count, where, GP_FALSE, 0) == GP.GOOD) {
    cs_log_printf(FILELINE, 3, "PDIN station: %s", sttn.station);
}

count = -1;
STTN_select_LOOP(&sttn, &count, "", GP_FALSE, 0);
```

---

### STTN_update

**Signature:**
```cpp
long STTN_update(STTN *sel);
```

**Description:**
Updates an existing STTN record. Used to synchronize database state with shared memory.

---

## Station Type Values

| Type | Constant | Description |
|------|----------|-------------|
| 1 | `GP.ST.TYP.PDIN` | Pickup/Dropoff Input |
| 2 | `GP.ST.TYP.PDOUT` | Pickup/Dropoff Output |
| 3 | `GP.ST.TYP.INFED` | Infeed station |
| 4 | `GP.ST.TYP.OUTFD` | Outfeed station |
| 5 | `GP.ST.TYP.DIVRT` | Divert station |
| 6 | `GP.ST.TYP.MERGE` | Merge station |

---

## Common Usage Patterns

### Pattern 1: Check Station Availability

```cpp
STTN sttn;
STTN_init(&sttn);
cc_str.copy(sttn.station, sizeof(sttn.station), "PD01");
cc_str.copy(sttn.area, sizeof(sttn.area), "A");

if (STTN_select_STTN_PR_KEY(&sttn, GP_FALSE) == GP.GOOD) {
    if (sttn.enabled == 1 && 
        sttn.available == 1 && 
        sttn.loaded == 0 && 
        sttn.enroute < sttn.max_enroute) {
        // Station is available
        return GP.GOOD;
    } else {
        // Station not available
        return GP.BAD;
    }
}
```

---

## Related Tables

| Table | Relationship | Foreign Key |
|-------|--------------|-------------|
| `MHC_MOVS` | Reference | `MHC_MOVS.current_station = MHC_STTN.station` |
| `MHC_LOAD` | Reference | `MHC_LOAD.current_station = MHC_STTN.station` |
| Shared Memory | Synchronized | `cc_stand` class mirrors STTN data |

---

## Cross-References

| Topic | Document | Section |
|-------|----------|---------|
| Stand Control | [CCSUB Library](../ccsub.md) | cc_stand class |
| Move Dispatcher | [p_ar_movdp](../01_Background_Processes/p_ar_movdp.md) | Uses STTN |
| DSUB Stand Ops | [DSUB Library](../dsub.md) | ds_stand functions |

---

## Changelog

| Version | Date | Changes |
|---------|------|---------|
| 1.0 | 2024-12-23 | Initial comprehensive documentation |

