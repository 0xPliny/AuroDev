# os_load - MHC_LOAD Table Operations

**Document Version:** 1.0  
**Last Updated:** 2024-12-23  
**Author:** CmL  
**Confidence Score:** 0.95

---

## Document Metadata

| Field | Value |
|-------|-------|
| **Source File** | `os_load.cpp`, `os_load.h` |
| **Generated From** | `MHC_LOAD` table definition in `database_tables.xml` |
| **Location** | `D:\ICIS\AuroDev\clogan\AuroDev\MSVC Programs\osub\` |
| **Table Name** | `MHC_LOAD` |
| **Primary Key** | `loadid`, `area` (composite) |
| **Generated By** | `p_ut_makdb` utility |
| **Status** | âœ… Generated - DO NOT MODIFY |

---

## Overview

The `MHC_LOAD` table is the **core load master table** in the MHC system. Every physical load (pallet, case, container) in the system has a corresponding LOAD record that tracks its current state, location, and attributes.

**Critical Operations:**
- Load creation (insert)
- Load location updates (update)
- Load status tracking
- Load history tracking

**Relationship to MOVS:**
- One LOAD can have multiple MOVS records (one active move at a time)
- LOAD tracks the physical load; MOVS tracks movement operations

---

## Table Structure

```cpp
typedef struct load
{
    // Audit Fields
    char    modify_user[132+1];          // User who last modified record
    char    history_func[50+1];          // Function that created history entry
    char    history_comment[256+1];      // History comment text
    char    add_date[24+1];              // Date record was added
    char    add_user[132+1];             // User who added record
    char    modify_date[24+1];           // Date record was last modified
    
    // Primary Key Fields
    char    loadid[6+1];                 // Load ID (part of primary key)
    char    area[1+1];                   // System area (part of primary key)
    
    // Load Status Fields
    char    load_status[20+1];          // Current load status (ACTV, STOR, SHIP, etc.)
    char    location[11+1];             // Current location
    char    current_station[30+1];      // Current station
    char    location_type[20+1];        // Location type (STOR, INTRAN, OUTSYS, etc.)
    
    // Load Type Fields
    char    load_type[20+1];           // Load type (PALLET, CASE, etc.)
    char    load_sub_type[20+1];       // Load sub-type
    long    load_size;                 // Load size code
    
    // Aisle/Equipment Fields
    long    aisle;                     // Current aisle
    char    sr_name[50+1];             // Stacker name (if stored)
    
    // Movement Tracking Fields
    char    stored_from[20+1];         // Station where load was stored from
    char    retrieved_from[20+1];      // Station where load was retrieved from
    char    received_date[24+1];       // Date load was received into system
    char    last_store_date[24+1];     // Date load was last stored
    
    // History Fields
    long    history_onoff;              // History on/off flag
    long    history_sequence_no;        // History sequence number
    
    // Internal Fields
    char    LOAD_dum[1];               // Dummy field (alignment)
    _RecordsetPtr    RsP;              // ADO Recordset pointer (internal use)
} LOAD;
```

---

## Primary Key

| Field(s) | Type | Description |
|----------|------|-------------|
| `loadid` | `char[7]` | Load identifier (e.g., "L00001") |
| `area` | `char[2]` | System area (typically "A") |

**Note:** The composite primary key allows multiple loads with the same ID in different areas (rare but possible).

---

## Generated Functions

### LOAD_select_LOAD_PR_KEY

**Signature:**
```cpp
long LOAD_select_LOAD_PR_KEY(LOAD *sel, GP_BOOL Update);
```

**Description:**
Selects a single LOAD record by primary key (`loadid` and `area`). This is the most common way to retrieve a specific load record.

**Parameters:**
- `sel` (LOAD*): Pointer to LOAD structure. Must have `loadid` and `area` set before calling.
- `Update` (GP_BOOL): 
  - `GP_TRUE`: Lock record for update (pessimistic lock)
  - `GP_FALSE`: Read-only access

**Return Values:**
- `GP.GOOD` (0): Record found and loaded
- `GP.UGLY` (-2): Record not found
- `GP.DBHELD` (-1): Record locked by another process
- Other: Database error

**SQL Generated:**
```sql
SELECT * FROM MHC_LOAD WHERE Loadid = '{loadid}' AND Area = '{area}'
```

**Usage Example:**
```cpp
LOAD load;
LOAD_init(&load);
cc_str.copy(load.loadid, sizeof(load.loadid), "L00001");
cc_str.copy(load.area, sizeof(load.area), "A");

if (LOAD_select_LOAD_PR_KEY(&load, GP_FALSE) == GP.GOOD) {
    cs_log_printf(FILELINE, 3, "Load %s: status=%s, location=%s", 
                  load.loadid, load.load_status, load.location);
} else {
    cs_log_printf(FILELINE, 0, "Load not found: %s", load.loadid);
}
```

---

### LOAD_select_LOOP

**Signature:**
```cpp
long LOAD_select_LOOP(LOAD *sel, long *count, char *where, GP_BOOL Update, int top = 0);
```

**Description:**
Selects multiple LOAD records using a WHERE clause. Designed for iteration through result sets.

**Parameters:**
- `sel` (LOAD*): Pointer to LOAD structure
- `count` (long*): 
  - First call: Set to 0
  - Subsequent calls: Pass same pointer (function increments)
  - Close cursor: Set to -1
- `where` (char*): SQL WHERE clause (without "WHERE" keyword)
- `Update` (GP_BOOL): Lock type
- `top` (int): Optional. Limit number of records (0 = no limit)

**Return Values:**
- `GP.GOOD` (0): Record retrieved
- `GP.UGLY` (-2): No more records (EOF)
- `GP.DBHELD` (-1): Record locked
- Other: Database error

**Usage Example:**
```cpp
LOAD load;
LOAD_init(&load);
long count = 0;
char where[256];
sprintf(where, "load_status = 'STOR' AND area = 'A' ORDER BY received_date");

// Iterate through all stored loads
while (LOAD_select_LOOP(&load, &count, where, GP_FALSE, 0) == GP.GOOD) {
    cs_log_printf(FILELINE, 3, "Stored load: %s at location %s", 
                  load.loadid, load.location);
    // Process load
}

// Close cursor
count = -1;
LOAD_select_LOOP(&load, &count, "", GP_FALSE, 0);
```

---

### LOAD_insert

**Signature:**
```cpp
long LOAD_insert(LOAD *sel, ...);
```

**Description:**
Inserts a new LOAD record into the database. All required fields must be set before calling.

**Required Fields:**
- `loadid` (primary key)
- `area` (primary key)
- `load_status`
- `load_type`
- `add_date` (typically set automatically)
- `add_user` (typically set automatically)

**Usage Example:**
```cpp
SQL.start(SQL.READ_WRITE);

LOAD load;
LOAD_init(&load);

// Set primary key
cc_str.copy(load.loadid, sizeof(load.loadid), "L00001");
cc_str.copy(load.area, sizeof(load.area), "A");

// Set required fields
cc_str.copy(load.load_status, sizeof(load.load_status), "ACTV");
cc_str.copy(load.load_type, sizeof(load.load_type), "PALLET");
cc_str.copy(load.location, sizeof(load.location), "IN-TR-AN");
cc_str.copy(load.current_station, sizeof(load.current_station), "PD01");

// Set audit fields
double curDate;
cs_dtm_current(&curDate);
cs_dtm_fmt(load.add_date, sizeof(load.add_date), curDate, DTM_MASK);
cc_str.copy(load.add_user, sizeof(load.add_user), gg.prgnam());

if (LOAD_insert(&load) == GP.GOOD) {
    SQL.commit();
    cs_log_printf(FILELINE, 3, "Load created: %s", load.loadid);
} else {
    SQL.rollback();
    cs_log_printf(FILELINE, 0, "Failed to create load: %s", load.loadid);
}
```

---

### LOAD_update

**Signature:**
```cpp
long LOAD_update(LOAD *sel);
long LOAD_update(LOAD *sel, char* table);
```

**Description:**
Updates an existing LOAD record. Record must have been selected with `Update = GP_TRUE` or be within an active transaction.

**Usage Example:**
```cpp
SQL.start(SQL.READ_WRITE);

LOAD load;
LOAD_init(&load);
cc_str.copy(load.loadid, sizeof(load.loadid), "L00001");
cc_str.copy(load.area, sizeof(load.area), "A");

// Select with lock for update
if (LOAD_select_LOAD_PR_KEY(&load, GP_TRUE) == GP.GOOD) {
    // Modify fields
    cc_str.copy(load.load_status, sizeof(load.load_status), "STOR");
    cc_str.copy(load.location, sizeof(load.location), "A01-01-01");
    cc_str.copy(load.current_station, sizeof(load.current_station), "SR01");
    load.aisle = 1;
    
    // Update audit fields
    double curDate;
    cs_dtm_current(&curDate);
    cs_dtm_fmt(load.modify_date, sizeof(load.modify_date), curDate, DTM_MASK);
    cc_str.copy(load.modify_user, sizeof(load.modify_user), gg.prgnam());
    
    // Create history
    LOAD_history(&load, "LOCATION_CHANGE", "Load stored", 
                 gg.prgnam(), 3);
    
    if (LOAD_update(&load) == GP.GOOD) {
        SQL.commit();
        cs_log_printf(FILELINE, 3, "Load updated: %s", load.loadid);
    } else {
        SQL.rollback();
    }
}
```

---

### LOAD_delete

**Signature:**
```cpp
long LOAD_delete(LOAD *sel);
```

**Description:**
Deletes a single LOAD record. Record must be selected first.

**Warning:** Deletion of LOAD records is **extremely rare** and should only be done for test data or system cleanup. Production loads should never be deleted.

---

### LOAD_count

**Signature:**
```cpp
long LOAD_count(LOAD *sel, long* i_count, char *where);
long LOAD_count(LOAD *sel, long* i_count, char* what, char *where);
```

**Description:**
Counts LOAD records matching a WHERE clause.

**Usage Example:**
```cpp
LOAD load;
LOAD_init(&load);
long count = 0;
char where[256];
sprintf(where, "load_status = 'STOR' AND area = 'A'");

if (LOAD_count(&load, &count, where) == GP.GOOD) {
    cs_log_printf(FILELINE, 3, "Stored loads: %ld", count);
}
```

---

### LOAD_sum

**Signature:**
```cpp
long LOAD_sum(LOAD *sel, long* i_count, char *sum, char *where);
```

**Description:**
Sums a numeric field for LOAD records matching a WHERE clause.

---

### LOAD_history

**Signature:**
```cpp
void LOAD_history(LOAD *sel, char* history_catagory, char* history_comment, 
                   char* history_func, long history_level);
void LOAD_history(LOAD *sel, char* history_catagory, char* history_comment, 
                  char* history_func, long history_level, long history_onoff);
```

**Description:**
Creates a history entry for the LOAD record. History is written to `MHC_LOAD_LOG` table.

---

### LOAD_init

**Signature:**
```cpp
void LOAD_init(LOAD *sel);
```

**Description:**
Initializes a LOAD structure to default values. **Always call this before using a LOAD structure.**

---

### LOAD_copy

**Signature:**
```cpp
void LOAD_copy(LOAD *to, LOAD *from);
void LOAD_copy(LOAD *to, LOAD *from, const bool with_RSP);
```

**Description:**
Copies one LOAD structure to another.

---

### LOAD_get

**Signature:**
```cpp
char* LOAD_get(LOAD *sel, char* field, char* format, char* buffer, size_t sizeInBytes);
```

**Description:**
Gets a formatted field value from LOAD structure.

---

## Static Class Wrapper: db_LOAD

```cpp
static class db_LOAD {
public:
    long PR_KEY(LOAD *sel, GP_BOOL Update);
    long LOOP(LOAD *sel, long *count, char *where, GP_BOOL Update);
    long LOOP(LOAD *sel, long *count, char *where, GP_BOOL Update, int top);
    long LOOP_2(LOAD *sel, long *count, char *where, char Update);
    long delete_it(LOAD *sel);
    long delete_where(LOAD *sel, char *where);
    long delete_where(LOAD *sel, char *where, char *top);
    long update_where(LOAD *sel, char *strset, char *where);
    long update(LOAD *sel);
    long update(LOAD *sel, char* up_table);
    long insert(LOAD *sel);
    long count(LOAD *sel, long* i_count, char *where);
    long count(LOAD *sel, long* i_count, char* what, char *where);
    long sum(LOAD *sel, long* i_count, char *sum, char *where);
    void init(LOAD *sel);
    void history(LOAD *sel, char* cat, char* comment, char* func, long level);
    void history(LOAD *sel, char* cat, char* comment, char* func, long level, long onoff);
    void copy(LOAD *to, LOAD *from);
    void copy(LOAD *to, LOAD *from, const bool with_RSP);
    char* get(LOAD *sel, char* field, char* format, char* buffer, size_t sizeInBytes);
} LOAD_;
```

---

## Common Usage Patterns

### Pattern 1: Select Single Load

```cpp
LOAD load;
LOAD_init(&load);
cc_str.copy(load.loadid, sizeof(load.loadid), "L00001");
cc_str.copy(load.area, sizeof(load.area), "A");

if (LOAD_select_LOAD_PR_KEY(&load, GP_FALSE) == GP.GOOD) {
    cs_log_printf(FILELINE, 3, "Load %s: status=%s, location=%s", 
                  load.loadid, load.load_status, load.location);
}
```

### Pattern 2: Update Load Location

```cpp
SQL.start(SQL.READ_WRITE);

LOAD load;
LOAD_init(&load);
cc_str.copy(load.loadid, sizeof(load.loadid), "L00001");
cc_str.copy(load.area, sizeof(load.area), "A");

if (LOAD_select_LOAD_PR_KEY(&load, GP_TRUE) == GP.GOOD) {
    // Update location
    cc_str.copy(load.location, sizeof(load.location), "A01-01-01");
    cc_str.copy(load.current_station, sizeof(load.current_station), "SR01");
    load.aisle = 1;
    
    // Update audit
    double curDate;
    cs_dtm_current(&curDate);
    cs_dtm_fmt(load.modify_date, sizeof(load.modify_date), curDate, DTM_MASK);
    cc_str.copy(load.modify_user, sizeof(load.modify_user), gg.prgnam());
    
    if (LOAD_update(&load) == GP.GOOD) {
        SQL.commit();
    } else {
        SQL.rollback();
    }
}
```

### Pattern 3: Find Loads by Location

```cpp
LOAD load;
LOAD_init(&load);
long count = 0;
char where[256];
sprintf(where, "location = 'A01-01-01' AND area = 'A'");

while (LOAD_select_LOOP(&load, &count, where, GP_FALSE, 0) == GP.GOOD) {
    cs_log_printf(FILELINE, 3, "Load at location: %s (status: %s)", 
                  load.loadid, load.load_status);
}

count = -1;
LOAD_select_LOOP(&load, &count, "", GP_FALSE, 0);
```

---

## Load Status Values

Common load status values (see `ICISDefines.vb` or `global_prm.h`):

| Status | Constant | Description |
|--------|----------|-------------|
| `ACTV` | `GP.LOAD.STATUS.ACTV` | Active - load in system |
| `STOR` | `GP.LOAD.STATUS.STOR` | Stored - load in storage location |
| `SHIP` | `GP.LOAD.STATUS.SHIP` | Shipped - load shipped out |
| `PROB` | `GP.LOAD.STATUS.PROB` | Problem - load has issues |
| `HOLD` | `GP.LOAD.STATUS.HOLD` | Hold - load on hold |

---

## Location Type Values

| Type | Description |
|------|-------------|
| `STOR` | Storage location (rack position) |
| `INTRAN` | In-transit location |
| `OUTSYS` | Out-of-system location |
| `STTN` | Station location |

---

## Related Tables

| Table | Relationship | Foreign Key |
|-------|--------------|-------------|
| `MHC_MOVS` | Child | `MHC_MOVS.loadid = MHC_LOAD.loadid` |
| `MHC_INVENTORY` | Child | `MHC_INVENTORY.loadid = MHC_LOAD.loadid` |
| `MHC_LOCATION` | Reference | `MHC_LOCATION.location = MHC_LOAD.location` |
| `MHC_LOAD_LOG` | History | `MHC_LOAD_LOG.loadid = MHC_LOAD.loadid` |

---

## Cross-References

| Topic | Document | Section |
|-------|----------|---------|
| Database Schema | [MHC_LOAD Schema](../../04_Database_Reference/01_Core_Tables/MHC_LOAD.md) | Table Definition |
| Move Operations | [os_movs.md](os_movs.md) | MOVS uses LOAD |
| Location Operations | [os_locn.md](os_locn.md) | LOCN references LOAD |
| Load Creation | [DSUB Library](../dsub.md) | ds_create_load |
| Workflows | [Inbound Move](../../05_Workflows/01_Inbound_Move.md) | Load Creation |

---

## Changelog

| Version | Date | Changes |
|---------|------|---------|
| 1.0 | 2024-12-23 | Initial comprehensive documentation |

