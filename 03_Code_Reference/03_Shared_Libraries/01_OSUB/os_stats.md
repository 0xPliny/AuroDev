# os_stats - MHC_STATS Table Operations

**Document Version:** 1.0  
**Last Updated:** 2024-12-23  
**Author:** CmL  
**Confidence Score:** 0.95

---

## Document Metadata

| Field | Value |
|-------|-------|
| **Source File** | `os_stats.cpp`, `os_stats.h` |
| **Generated From** | `MHC_STATS` table definition in `database_tables.xml` |
| **Location** | `D:\ICIS\AuroDev\clogan\AuroDev\MSVC Programs\osub\` |
| **Table Name** | `MHC_STATS` |
| **Primary Key** | `sequence_no`, `area` (composite) |
| **Generated By** | `p_ut_makdb` utility |
| **Status** | âœ… Generated - DO NOT MODIFY |

---

## Overview

The `MHC_STATS` table stores **performance statistics** for devices and system components. Statistics are collected periodically and rolled up from half-hourly to hourly, daily, and monthly intervals.

**Critical Operations:**
- Statistics collection and storage
- Performance reporting
- Utilization analysis
- Historical trend analysis

---

## Table Structure

```cpp
typedef struct stats
{
    // Primary Key Fields
    long    sequence_no;                  // Sequence number
    char    area[1+1];                    // System area
    
    // Device Identification Fields
    char    device_type[22+1];            // Device type (e.g., "STACKER", "STATION")
    char    device_name[50+1];            // Device name (e.g., "SR01", "PD01")
    char    stat_type[20+1];              // Stat type (e.g., "HALF_HOUR", "HOUR", "DAY")
    char    stat_period[20+1];            // Stat period (e.g., "2024-12-23 10:00")
    
    // Time Statistics (in seconds)
    double    online_idle_time;           // Time online and idle
    double    online_busy_loaded_time;     // Time online, busy, and loaded
    double    online_busy_empty_time;      // Time online, busy, and empty
    double    offline_time;                // Time offline
    double    error_time;                  // Time in error state
    
    // Battery Statistics (for AGVs)
    double    batt_ok_time;                // Battery OK time
    double    batt_low_time;               // Battery low time
    double    batt_charge_time;            // Battery charging time
    
    // Operation Counts
    long    store_count;                   // Number of store operations
    long    retr_count;                    // Number of retrieve operations
    long    reject_count;                  // Number of reject operations
    long    cxfr_count;                    // Number of conveyor transfers
    long    cxfre_count;                   // Number of conveyor transfer errors
    long    sxfr_count;                    // Number of station transfers
    long    move_count;                    // Number of move operations
    long    bcr_read_count;                // Number of BCR reads
    long    bcr_fail_count;                // Number of BCR read failures
    long    scale_read_count;              // Number of scale reads
    long    scale_fail_count;              // Number of scale read failures
    
    // Location Statistics
    long    all_locn_cnt;                  // Total location count
    long    avg_storable_locn_cnt;         // Average storable location count
    double    avg_pct_full;                // Average percent full
    
    // Time Fields
    char    reset_time[24+1];              // Statistics reset time
    char    shift_times[50+1];             // Shift times
    
    // Message Field
    char    message[4000+1];               // Additional message/notes
    
    // Audit Fields
    char    add_date[24+1];                // Date record was added
    char    add_user[132+1];               // User who added record
    char    modify_date[24+1];             // Date record was last modified
    char    modify_user[132+1];            // User who last modified record
    
    // Internal Fields
    _RecordsetPtr    RsP;                   // ADO Recordset pointer (internal use)
} STATS;
```

---

## Primary Key

| Field(s) | Type | Description |
|----------|------|-------------|
| `sequence_no` | `long` | Sequence number |
| `area` | `char[2]` | System area |

---

## Generated Functions

### STATS_select_STATS_PR_KEY

**Signature:**
```cpp
long STATS_select_STATS_PR_KEY(STATS *sel, GP_BOOL Update);
```

**Description:**
Selects a single STATS record by primary key.

---

### STATS_select_LOOP

**Signature:**
```cpp
long STATS_select_LOOP(STATS *sel, long *count, char *where, GP_BOOL Update, int top = 0);
```

**Description:**
Selects multiple STATS records using a WHERE clause. Commonly used for statistics reporting.

**Usage Example:**
```cpp
STATS stats;
STATS_init(&stats);
long count = 0;
char where[256];
sprintf(where, "device_name = 'SR01' AND stat_type = 'HOUR' AND stat_period >= '2024-12-23 00:00' ORDER BY stat_period");

// Get hourly statistics for SR01 today
while (STATS_select_LOOP(&stats, &count, where, GP_FALSE, 0) == GP.GOOD) {
    double utilization = (stats.online_busy_loaded_time + stats.online_busy_empty_time) / 
                          (stats.online_idle_time + stats.online_busy_loaded_time + stats.online_busy_empty_time) * 100.0;
    cs_log_printf(FILELINE, 3, "SR01 stats for %s: stores=%ld, retrs=%ld, util=%.1f%%", 
                  stats.stat_period, stats.store_count, stats.retr_count, utilization);
}

count = -1;
STATS_select_LOOP(&stats, &count, "", GP_FALSE, 0);
```

---

## Related Tables

| Table | Relationship | Foreign Key |
|-------|--------------|-------------|
| `MHC_STK` | Reference | `MHC_STATS.device_name = MHC_STK.devicename` |
| `MHC_STTN` | Reference | `MHC_STATS.device_name = MHC_STTN.station` |

---

## Cross-References

| Topic | Document | Section |
|-------|----------|---------|
| Statistics Collection | [Statistics Collection](../../07_Statistics/01_Statistics_Collection.md) | Stats Roll-up |
| Performance Monitoring | [Performance Monitoring](../../07_Statistics/02_Performance_Monitoring.md) | Utilization |

---

## Changelog

| Version | Date | Changes |
|---------|------|---------|
| 1.0 | 2024-12-23 | Initial comprehensive documentation |

